<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - é€šè®¯å½•ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container login-container">
        <div class="card login-card">
            <h2>ğŸ“‡ é€šè®¯å½•ç®¡ç†ç³»ç»Ÿ</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('login')">ç™»å½•</button>
                <button class="tab-btn" onclick="showTab('register')">æ³¨å†Œ</button>
            </div>

            <div id="login-tab" class="tab-content active">
                <input type="text" id="login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" class="form-input">
                <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " class="form-input">
                <button class="btn login-btn" onclick="login()">ç™»å½•</button>
            </div>

            <div id="register-tab" class="tab-content">
                <input type="text" id="reg-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" class="form-input">
                <input type="password" id="reg-password" placeholder="è¯·è¾“å…¥å¯†ç " class="form-input">
                <input type="email" id="reg-email" placeholder="è¯·è¾“å…¥é‚®ç®±ï¼ˆå¯é€‰ï¼‰" class="form-input">
                <button class="btn reg-btn" onclick="register()">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab-btn[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        // å…³é”®ï¼šåç«¯åœ°å€å¿…é¡»å’Œåç«¯å¯åŠ¨çš„åœ°å€ä¸€è‡´
        const BASE_URL = 'http://127.0.0.1:5000/api';

        function register() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            const email = document.getElementById('reg-email').value.trim();

            if (!username) { alert('è¯·è¾“å…¥ç”¨æˆ·åï¼'); return; }
            if (!password) { alert('è¯·è¾“å…¥å¯†ç ï¼'); return; }
            if (password.length < 6) { alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼'); return; }
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼'); return; }

            const regBtn = document.querySelector('.reg-btn');
            regBtn.disabled = true;
            regBtn.textContent = 'æ³¨å†Œä¸­...';

            // å‘é€æ³¨å†Œè¯·æ±‚ï¼ˆè°ƒè¯•ç”¨ï¼šæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°çœ‹è¯·æ±‚è¯¦æƒ…ï¼‰
            axios.post(`${BASE_URL}/register`, { username, password, email })
                .then(res => {
                    alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                    showTab('login');
                    document.getElementById('reg-username').value = '';
                    document.getElementById('reg-password').value = '';
                    document.getElementById('reg-email').value = '';
                })
                .catch(err => {
                    // æ‰“å°é”™è¯¯è¯¦æƒ…åˆ°æ§åˆ¶å°ï¼ˆF12æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹ï¼‰
                    console.error('æ³¨å†Œé”™è¯¯:', err);
                    const errMsg = err.response?.data?.message ||
                                  (err.message.includes('Network Error') ? 'åç«¯æœªå¯åŠ¨æˆ–åœ°å€é”™è¯¯' : 'æ³¨å†Œå¤±è´¥');
                    alert(`æ³¨å†Œå¤±è´¥ï¼š${errMsg}`);
                })
                .finally(() => {
                    regBtn.disabled = false;
                    regBtn.textContent = 'æ³¨å†Œ';
                });
        }

        function login() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!username) { alert('è¯·è¾“å…¥ç”¨æˆ·åï¼'); return; }
            if (!password) { alert('è¯·è¾“å…¥å¯†ç ï¼'); return; }

            const loginBtn = document.querySelector('.login-btn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å½•ä¸­...';

            axios.post(`${BASE_URL}/login`, { username, password })
                .then(res => {
                    localStorage.setItem('user_id', res.data.data.user_id);
                    localStorage.setItem('username', res.data.data.username);
                    window.location.href = 'index.html';
                })
                .catch(err => {
                    console.error('ç™»å½•é”™è¯¯:', err);
                    const errMsg = err.response?.data?.message || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                    alert(`ç™»å½•å¤±è´¥ï¼š${errMsg}`);
                })
                .finally(() => {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ç™»å½•';
                });
        }

        window.onload = function() {
            const userId = localStorage.getItem('user_id');
            if (userId) window.location.href = 'index.html';
        }
    </script>
</body>
</html>