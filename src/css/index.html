<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šè®¯å½•ç®¡ç†ç³»ç»Ÿ - ä¸»é¡µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .form-input, .select-control {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
            width: 200px;
        }
        .btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .contact-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .contact-form input, .contact-form select {
            flex: 1;
            min-width: 150px;
        }
        .search-bar, .import-export {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
        }
        .favorite-btn {
            color: #ffc107;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }
        .action-btn {
            padding: 4px 8px;
            margin-right: 5px;
            font-size: 12px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .loading {
            color: #007bff;
            font-size: 14px;
            margin-left: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ“‡ é€šè®¯å½•ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="user-info">
                <span>å½“å‰ç™»å½•ï¼š<span id="current-username"></span></span>
                <button class="btn btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <div class="card">
            <h3>ğŸ” è”ç³»äººæ£€ç´¢</h3>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="è¾“å…¥å§“å/ç”µè¯å…³é”®è¯..." class="form-input">
                <button class="btn" onclick="searchContacts()">æœç´¢</button>
                <button class="btn" onclick="filterFavorites()">åªçœ‹æ”¶è—</button>
                <button class="btn btn-secondary" onclick="resetSearch()">é‡ç½®ç­›é€‰</button>
            </div>
            <div class="import-export">
                <button class="btn" onclick="exportCSV()">å¯¼å‡ºCSV</button>
                <button class="btn" onclick="exportExcel()">å¯¼å‡ºExcel</button>
                <input type="file" id="excel-import" accept=".xlsx" style="display: none;" onchange="importExcelFile()">
                <button class="btn" onclick="document.getElementById('excel-import').click()">å¯¼å…¥Excel</button>
                <button class="btn btn-secondary" onclick="downloadExcelTemplate()">ä¸‹è½½Excelæ¨¡æ¿</button>
                <span id="upload-status" style="color: #666; display: none;">ä¸Šä¼ ä¸­...</span>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ åˆ†ç»„ç®¡ç†</h3>
            <input type="text" id="new-group-name" placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°..." class="form-input">
            <button class="btn" onclick="addGroup()">æ·»åŠ åˆ†ç»„</button>
            <select id="group-filter" class="select-control" onchange="filterByGroup()">
                <option value="0">å…¨éƒ¨åˆ†ç»„</option>
            </select>
        </div>

        <div class="card">
            <h3>â• æ·»åŠ æ–°è”ç³»äºº</h3>
            <div class="contact-form">
                <input type="text" id="add-name" placeholder="å§“å *" required class="form-input">
                <input type="tel" id="add-phone1" placeholder="ç”µè¯1 *" required class="form-input">
                <input type="tel" id="add-phone2" placeholder="ç”µè¯2" class="form-input">
                <input type="email" id="add-email1" placeholder="é‚®ç®±1" class="form-input">
                <input type="email" id="add-email2" placeholder="é‚®ç®±2" class="form-input">
                <input type="text" id="add-social" placeholder="ç¤¾äº¤è´¦å·ï¼ˆå¾®ä¿¡/QQç­‰ï¼‰" class="form-input">
                <input type="text" id="add-address" placeholder="è”ç³»åœ°å€" class="form-input">
                <select id="add-group" class="select-control">
                    <option value="0">æœªåˆ†ç»„</option>
                </select>
                <label>
                    <input type="checkbox" id="add-favorite"> è®¾ä¸ºæ”¶è—
                </label>
                <button class="btn" onclick="addNewContact()">æ·»åŠ è”ç³»äºº</button>
                <span id="add-loading" class="loading" style="display: none;">æäº¤ä¸­...</span>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“‹ è”ç³»äººåˆ—è¡¨</h3>
            <table id="contacts-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>ç”µè¯1</th>
                        <th>ç”µè¯2</th>
                        <th>é‚®ç®±</th>
                        <th>åœ°å€</th>
                        <th>åˆ†ç»„</th>
                        <th>æ”¶è—</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="contacts-body">
                    <tr><td colspan="8" style="text-align:center;">æš‚æ— è”ç³»äººæ•°æ®</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // åŸºç¡€é…ç½®
        const BASE_URL = 'http://127.0.0.1:5000/api';
        const user_id = localStorage.getItem('user_id') || '1';
        const username = localStorage.getItem('username') || 'æµ‹è¯•ç”¨æˆ·';

        // å…¨å±€é…ç½®axiosï¼šæ¢å¤é»˜è®¤çš„JSONè¯·æ±‚é…ç½®ï¼ˆè§£å†³æ·»åŠ è”ç³»äºº415é”™è¯¯ï¼‰
        axios.defaults.timeout = 15000;
        axios.defaults.headers.common['X-User-Id'] = user_id;
        // æ¢å¤POST/PUTçš„é»˜è®¤Content-Typeï¼ˆç”¨äºJSONè¯·æ±‚ï¼šæ·»åŠ /ä¿®æ”¹è”ç³»äººã€æ·»åŠ åˆ†ç»„ï¼‰
        axios.defaults.headers.post['Content-Type'] = 'application/json';
        axios.defaults.headers.put['Content-Type'] = 'application/json';
        // æ¢å¤é»˜è®¤çš„è¯·æ±‚è½¬æ¢ï¼ˆå°†JSONå¯¹è±¡åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼‰
        axios.defaults.transformRequest = [function (data, headers) {
            // å¦‚æœæ˜¯FormDataï¼ˆExcelä¸Šä¼ ï¼‰ï¼Œç›´æ¥è¿”å›ï¼Œä¸åºåˆ—åŒ–
            if (data instanceof FormData) {
                return data;
            }
            // å¦åˆ™åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²
            return JSON.stringify(data);
        }];

        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            if (!user_id) {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('current-username').textContent = username;
            checkBackendHealth();
            loadGroups();
            loadContacts();
        };

        // æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
        function checkBackendHealth() {
            axios.get(`${BASE_URL}/health`).catch(err => {
                alert('âŒ åç«¯æœåŠ¡æœªå¯åŠ¨ï¼Œè¯·å…ˆè¿è¡Œapp.pyï¼');
                console.error('åç«¯è¿æ¥å¤±è´¥ï¼š', err);
            });
        }

        // åŠ è½½åˆ†ç»„
        function loadGroups() {
            axios.get(`${BASE_URL}/groups`)
                .then(res => {
                    const groups = res.data.data || [];
                    const groupFilter = document.getElementById('group-filter');
                    const addGroupSelect = document.getElementById('add-group');
                    groupFilter.innerHTML = '<option value="0">å…¨éƒ¨åˆ†ç»„</option>';
                    addGroupSelect.innerHTML = '<option value="0">æœªåˆ†ç»„</option>';
                    groups.forEach(group => {
                        groupFilter.innerHTML += `<option value="${group.id}">${group.group_name}</option>`;
                        addGroupSelect.innerHTML += `<option value="${group.id}">${group.group_name}</option>`;
                    });
                })
                .catch(err => {
                    alert('åŠ è½½åˆ†ç»„å¤±è´¥ï¼š' + getErrMsg(err));
                });
        }

        // åŠ è½½è”ç³»äºº
        function loadContacts(filterParams = {}) {
            let url = `${BASE_URL}/contacts?`;
            if (filterParams.keyword) url += `keyword=${encodeURIComponent(filterParams.keyword)}&`;
            if (filterParams.group_id) url += `group_id=${filterParams.group_id}&`;
            if (filterParams.favorite !== undefined) url += `favorite=${filterParams.favorite}&`;

            axios.get(url)
                .then(res => {
                    const contacts = res.data.data || [];
                    const tbody = document.getElementById('contacts-body');
                    tbody.innerHTML = '';
                    if (contacts.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">æš‚æ— è”ç³»äººæ•°æ®</td></tr>';
                        return;
                    }
                    contacts.forEach(contact => {
                        const favoriteIcon = contact.is_favorite ? 'â˜…' : 'â˜†';
                        const groupName = document.querySelector(`#add-group option[value="${contact.group_id}"]`)?.text || 'æœªåˆ†ç»„';
                        tbody.innerHTML += `
                            <tr>
                                <td>${contact.name}</td>
                                <td>${contact.phone1}</td>
                                <td>${contact.phone2 || '-'}</td>
                                <td>${contact.email1 || '-'}</td>
                                <td>${contact.address || '-'}</td>
                                <td>${groupName}</td>
                                <td><button class="favorite-btn" onclick="toggleFavorite(${contact.id})">${favoriteIcon}</button></td>
                                <td>
                                    <button class="btn action-btn" onclick="editContact(${JSON.stringify(contact).replace(/"/g, '&quot;')})">ç¼–è¾‘</button>
                                    <button class="btn btn-secondary action-btn" onclick="deleteContact('${contact.phone1}')">åˆ é™¤</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    alert('åŠ è½½è”ç³»äººå¤±è´¥ï¼š' + getErrMsg(err));
                });
        }

        // æœç´¢è”ç³»äºº
        function searchContacts() {
            const keyword = document.getElementById('search-input').value.trim();
            loadContacts({ keyword });
        }

        // ç­›é€‰æ”¶è—
        function filterFavorites() {
            loadContacts({ favorite: 1 });
        }

        // é‡ç½®ç­›é€‰
        function resetSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('group-filter').value = '0';
            loadContacts();
        }

        // æŒ‰åˆ†ç»„ç­›é€‰
        function filterByGroup() {
            const group_id = document.getElementById('group-filter').value;
            loadContacts({ group_id });
        }

        // æ·»åŠ åˆ†ç»„
        function addGroup() {
            const groupName = document.getElementById('new-group-name').value.trim();
            if (!groupName) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°ï¼');
                return;
            }
            axios.post(`${BASE_URL}/groups`, { group_name: groupName })
                .then(res => {
                    alert('åˆ†ç»„æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('new-group-name').value = '';
                    loadGroups();
                    loadContacts();
                })
                .catch(err => {
                    alert('æ·»åŠ åˆ†ç»„å¤±è´¥ï¼š' + getErrMsg(err));
                });
        }

        // æ·»åŠ è”ç³»äºº
        function addNewContact() {
            const addBtn = document.querySelector('.contact-form .btn');
            const loading = document.getElementById('add-loading');
            const contactData = {
                name: document.getElementById('add-name').value.trim(),
                phone1: document.getElementById('add-phone1').value.trim(),
                phone2: document.getElementById('add-phone2').value.trim(),
                email1: document.getElementById('add-email1').value.trim(),
                email2: document.getElementById('add-email2').value.trim(),
                social_media: document.getElementById('add-social').value.trim(),
                address: document.getElementById('add-address').value.trim(),
                group_id: document.getElementById('add-group').value,
                is_favorite: document.getElementById('add-favorite').checked ? 1 : 0
            };

            // éªŒè¯
            if (!contactData.name) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }
            if (!contactData.phone1) {
                alert('è¯·è¾“å…¥ç”µè¯1ï¼');
                return;
            }
            if (!/^1[3-9]\d{9}$/.test(contactData.phone1)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„11ä½æ‰‹æœºå·ï¼');
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            addBtn.disabled = true;
            loading.style.display = 'inline';

            axios.post(`${BASE_URL}/contacts`, contactData)
                .then(res => {
                    alert(res.data.message || 'æ·»åŠ æˆåŠŸï¼');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('add-name').value = '';
                    document.getElementById('add-phone1').value = '';
                    document.getElementById('add-phone2').value = '';
                    document.getElementById('add-email1').value = '';
                    document.getElementById('add-email2').value = '';
                    document.getElementById('add-social').value = '';
                    document.getElementById('add-address').value = '';
                    document.getElementById('add-favorite').checked = false;
                    // åˆ·æ–°åˆ—è¡¨
                    loadContacts();
                })
                .catch(err => {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + getErrMsg(err));
                })
                .finally(() => {
                    addBtn.disabled = false;
                    loading.style.display = 'none';
                });
        }

        // åˆ‡æ¢æ”¶è—
        function toggleFavorite(contactId) {
            axios.put(`${BASE_URL}/contacts/favorite/${contactId}`)
                .then(res => {
                    loadContacts();
                })
                .catch(err => {
                    alert('æ“ä½œå¤±è´¥ï¼š' + getErrMsg(err));
                });
        }

        // ç¼–è¾‘è”ç³»äºº
        function editContact(contact) {
            const newName = prompt('ä¿®æ”¹å§“å', contact.name);
            const newPhone1 = prompt('ä¿®æ”¹ç”µè¯1', contact.phone1);
            if (!newName || !newPhone1) return;

            const editData = {
                old_phone: contact.phone1,
                new_name: newName,
                new_phone: newPhone1,
                new_phone2: prompt('ä¿®æ”¹ç”µè¯2', contact.phone2 || ''),
                new_email1: prompt('ä¿®æ”¹é‚®ç®±1', contact.email1 || ''),
                new_email2: prompt('ä¿®æ”¹é‚®ç®±2', contact.email2 || ''),
                new_social: prompt('ä¿®æ”¹ç¤¾äº¤è´¦å·', contact.social_media || ''),
                new_address: prompt('ä¿®æ”¹åœ°å€', contact.address || ''),
                new_group_id: prompt('ä¿®æ”¹åˆ†ç»„ID', contact.group_id),
                new_favorite: confirm('è®¾ä¸ºæ”¶è—ï¼Ÿ')
            };

            axios.put(`${BASE_URL}/contacts`, editData)
                .then(res => {
                    alert('ä¿®æ”¹æˆåŠŸï¼');
                    loadContacts();
                })
                .catch(err => {
                    alert('ä¿®æ”¹å¤±è´¥ï¼š' + getErrMsg(err));
                });
        }

        // åˆ é™¤è”ç³»äºº
        function deleteContact(phone) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥è”ç³»äººå—ï¼Ÿ')) return;
            axios.delete(`${BASE_URL}/contacts`, {
                data: { phone: phone },
                headers: {
                    'Content-Type': 'application/json' // æ˜¾å¼æŒ‡å®šDELETEçš„Content-Type
                }
            })
                .then(res => {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadContacts();
                })
                .catch(err => {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + getErrMsg(err));
                });
        }

        // å¯¼å‡ºCSV
        function exportCSV() {
            window.open(`${BASE_URL}/contacts/export?user_id=${user_id}`);
        }

        // å¯¼å‡ºExcel
        function exportExcel() {
            window.open(`${BASE_URL}/contacts/export/excel?user_id=${user_id}`);
        }

        // å¯¼å…¥Excelå‡½æ•°ï¼ˆå•ç‹¬é…ç½®multipart/form-dataï¼Œä¸å½±å“å…¶ä»–è¯·æ±‚ï¼‰
        function importExcelFile() {
            const fileInput = document.getElementById('excel-import');
            const file = fileInput.files[0];
            const uploadStatus = document.getElementById('upload-status');

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ç¼“å­˜ï¼ˆé¿å…é‡å¤ä¸Šä¼ ï¼‰
            const fileInputClone = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(fileInputClone, fileInput);
            window.excelImportInput = fileInputClone;
            fileInputClone.onchange = importExcelFile;

            // éªŒè¯æ–‡ä»¶
            if (!file) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„Excelæ–‡ä»¶ï¼');
                return;
            }
            if (!file.name.endsWith('.xlsx')) {
                alert('ä»…æ”¯æŒ.xlsxæ ¼å¼çš„Excelæ–‡ä»¶ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼');
                return;
            }

            // åˆ›å»ºFormDataï¼ˆçº¯åŸç”Ÿï¼‰
            const formData = new FormData();
            formData.append('file', file); // é”®åä¸¥æ ¼ä¸º'file'ï¼Œä¸åç«¯å¯¹åº”

            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            uploadStatus.style.display = 'inline';
            uploadStatus.textContent = 'ä¸Šä¼ ä¸­...';

            // å‘é€è¯·æ±‚ï¼šå•ç‹¬é…ç½®è¯·æ±‚å¤´ï¼ˆä»…è¿™é‡Œç”¨multipart/form-dataï¼‰
            axios.post(`${BASE_URL}/contacts/import/excel`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data', // è¦†ç›–é»˜è®¤çš„JSON Content-Type
                    'X-User-Id': user_id
                },
                // ç¦ç”¨JSONåºåˆ—åŒ–ï¼ˆå› ä¸ºæ˜¯FormDataï¼‰
                transformRequest: [(data) => data]
            })
            .then(res => {
                uploadStatus.textContent = 'ä¸Šä¼ å®Œæˆï¼';
                alert(`å¯¼å…¥ç»“æœï¼š${res.data.message}`);
                loadContacts(); // åˆ·æ–°åˆ—è¡¨
                // 3ç§’åéšè—çŠ¶æ€
                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                }, 3000);
            })
            .catch(err => {
                uploadStatus.textContent = 'ä¸Šä¼ å¤±è´¥ï¼';
                // å®Œæ•´çš„é”™è¯¯ä¿¡æ¯è§£æ
                let errMsg = 'å¯¼å…¥å¤±è´¥ï¼š';
                if (err.response) {
                    // åç«¯è¿”å›çš„é”™è¯¯
                    errMsg += err.response.data?.message || `çŠ¶æ€ç ${err.response.status}`;
                } else if (err.request) {
                    // æ— å“åº”
                    errMsg += 'åç«¯æœåŠ¡æ— å“åº”ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨';
                } else {
                    // è¯·æ±‚é…ç½®é”™è¯¯
                    errMsg += err.message;
                }
                alert(errMsg);
                // 3ç§’åéšè—çŠ¶æ€
                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                }, 3000);
            });
        }

        // ä¸‹è½½Excelæ¨¡æ¿
        function downloadExcelTemplate() {
            const templateData = [
                ["å§“å", "ç”µè¯1", "ç”µè¯2", "é‚®ç®±1", "é‚®ç®±2", "ç¤¾äº¤è´¦å·", "åœ°å€", "åˆ†ç»„ID", "åˆ†ç»„åç§°", "æ˜¯å¦æ”¶è—"],
                ["ç¤ºä¾‹-å¼ ä¸‰", "13800138000", "", "zhangsan@qq.com", "", "", "", 0, "æœªåˆ†ç»„", "å¦"]
            ];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            XLSX.utils.book_append_sheet(wb, ws, "é€šè®¯å½•æ¨¡æ¿");
            XLSX.writeFile(wb, "é€šè®¯å½•å¯¼å…¥æ¨¡æ¿.xlsx");
        }

        // ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆè§£å†³ä¸­æ–‡ä¹±ç ï¼‰
        function getErrMsg(err) {
            if (err.message.includes('Network Error')) {
                return 'åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–åœ°å€é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼š1.åç«¯æ˜¯å¦è¿è¡Œ 2.åœ°å€æ˜¯å¦ä¸ºhttp://127.0.0.1:5000';
            }
            if (err.message.includes('timeout')) {
                return 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æœåŠ¡';
            }
            let msg = err.response?.data?.message || err.message || 'æœªçŸ¥é”™è¯¯';
            try {
                msg = decodeURIComponent(escape(msg));
            } catch (e) {}
            return msg;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('user_id');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>